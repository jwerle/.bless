#!/usr/bin/env bash
declare USER=`whoami`
declare HOME_DIR=$(eval echo ~${USER})
declare BLESS_DIR=$HOME_DIR/.bless
declare BLESS_NODE_MODULES=$BLESS_DIR/node_modules
declare BLESS_SCRIPTS=$BLESS_DIR/scripts
declare -a BLESS_ARGS=( "$@" )

## loader
function require () {
	local root=$BLESS_DIR/lib/$1
	if test -f $root/index; then 
		root=$root/index;
	elif test -f $root/init; then 
		root=$root/init;
	elif test -f $root/$1; then 
		root=$root/$1;
	fi;

	if test -f "$root"; then
		source $root;
		return 0
	else
		declare  local command="$(commandFromPath "$1")"
		echo "dotbless: '${command}' is not a dotbless command. See 'dotbless --help'".
		return 1
	fi
}

##
# Core
## 
require "bless"


## commands
case "${BLESS_ARGS[0]}" in
	## output completions
	--completions )
		## shift off the first element
		unset BLESS_ARGS[0]
		CompletionList ${BLESS_ARGS[@]}
	;;
	
	## output version
	--version|-v )
		echo $($BLESS_SCRIPTS/version)
		exit 0;
	;;

	## output help
	--help|-h|help )
		BlessUsage
	;;

	## init completions
	--init-completions )
echo 'function _dotbless_completions_ () {
	local completions word words cur last;

  COMPREPLY=();
  word="${COMP_WORDS[COMP_CWORD]}";
  cur=$(expr $COMP_CWORD - 1);

  if [ "$word" == "--completion" ]; then
  	return 0;
  elif [ "$COMP_CWORD" -eq 1 ]; then
    COMPREPLY=( $(compgen -W "$(dotbless --completions)" -- "$word") );
  else
    declare -a words=(${COMP_WORDS[@]});

    unset words[0];
    unset words[$COMP_CWORD];

    completions=$(dotbless --completions "${words[@]:$cur}");
    COMPREPLY=( $(compgen -W "$completions" -- "$word") );
  fi
}

# enable completions
complete -F _dotbless_completions_ dotbless'

	;;

	## exit alias
	exit )
		exit 0
	;;

	## catch all
	* )
		if [[ -z ${BLESS_ARGS[@]} ]]; then
			BlessUsage
		else
			BlessCommand ${BLESS_ARGS[0]}
		fi
	;;
esac;